## 一、概述

Elasticsearch 是一个分布式的免费开源搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 以其简单的 REST 风格 API、分布式特性、速度和可扩展性而闻名，是 Elastic Stack 的核心组件；Elastic Stack 是一套适用于数据采集、扩充、存储、分析和可视化的免费开源工具。人们通常将 Elastic Stack 称为 ELK Stack（代指 Elasticsearch、Logstash 和 Kibana）；

### Elasticsearch 的用途是什么？

Elasticsearch 在速度和可扩展性方面都表现出色，而且还能够索引多种类型的内容，这意味着其可用于多种用例：

- 应用程序搜索
- 网站搜索
- 企业搜索
- 日志处理和分析
- 基础设施指标和容器监测
- 应用程序性能监测
- 地理空间数据分析和可视化
- 安全分析
- 业务分析

### Elasticsearch 的优点

**Elasticsearch 很快。**由于 Elasticsearch 是在 Lucene 基础上构建而成的，所以在全文本搜索方面表现十分出色。Elasticsearch 同时还是一个近实时的搜索平台，这意味着从文档索引操作到文档变为可搜索状态之间的延时很短，一般只有一秒。因此，Elasticsearch 非常适用于对时间有严苛要求的用例，例如安全分析和基础设施监测。

**Elasticsearch 具有分布式的本质特征。**Elasticsearch 中存储的文档分布在不同的容器中，这些容器称为*分片*，可以进行复制以提供数据冗余副本，以防发生硬件故障。Elasticsearch 的分布式特性使得它可以扩展至数百台（甚至数千台）服务器，并处理 PB 量级的数据。

**Elasticsearch 包含一系列广泛的功能。**除了速度、可扩展性和弹性等优势以外，Elasticsearch 还有大量强大的内置功能（例如数据汇总和索引生命周期管理），可以方便用户更加高效地存储和搜索数据。

**Elastic Stack 简化了数据采集、可视化和报告过程。**通过与 Beats 和 Logstash 进行集成，用户能够在向 Elasticsearch 中索引数据之前轻松地处理数据。同时，Kibana 不仅可针对 Elasticsearch 数据提供实时可视化，同时还提供 UI 以便用户快速访问应用程序性能监测 (APM)、日志和基础设施指标等数据。

## 二、工作原理

原始数据会从多个来源（包括日志、系统指标和网络应用程序）输入到 Elasticsearch 中。*数据采集*指在 Elasticsearch 中进行*索引*之前解析、标准化并充实这些原始数据的过程。这些数据在 Elasticsearch 中索引完成之后，用户便可针对他们的数据运行复杂的查询，并使用聚合来检索自身数据的复杂汇总。

### Elasticsearch 索引是什么？

Elasticsearch *索引*指相互关联的文档集合。Elasticsearch 会以 JSON 文档的形式存储数据。每个文档都会在一组*键*（字段或属性的名称）和它们对应的值（字符串、数字、布尔值、日期、*数值*组、地理位置或其他类型的数据）之间建立联系。

Elasticsearch 使用的是一种名为*倒排索引*的数据结构，这一结构的设计可以允许十分快速地进行全文本搜索。倒排索引会列出在所有文档中出现的每个特有词汇，并且可以找到包含每个词汇的全部文档。

在索引过程中，Elasticsearch 会存储文档并构建倒排索引，这样用户便可以近实时地对文档数据进行搜索。索引过程是在索引 API 中启动的，通过此 API 您既可向特定索引中添加 JSON 文档，也可更改特定索引中的 JSON 文档。

## 三、安装

这里以在 docker 中拉取镜像为例

### 3.1 基本安装运行

```shell
# 1、拉取镜像
docker pull elasticsearch:7.17.2   

# 2、创建存放数据及配置文件的文件夹，启动时挂载。
mkdir -p  /Library/elasticsearch/data/ 
mkdir -p  /Library/elasticsearch/config/

# 3、编写配置文件
echo 'http.host: 0.0.0.0
http.cors.enabled: true
http.cors.allow-origin: "*" '>>/Library/elasticsearch/config/elasticsearch.yml
# http.cors.enabled: true 和http.cors.allow-origin: "*"配置是为了解决跨域问题，因为等下还要下载可视化工具查看。

# 4、修改文件夹的权限
chmod -R 777 /Users/aafall/Documents/docker/es

# 5、使用镜像，创建容器并启动
docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" \
-e ES_JAVA_OPTS="-Xms64m -Xmx512m" \
-v /Users/aafall/Documents/docker/es/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
-v /Users/aafall/Documents/docker/es/data:/usr/share/elasticsearch/data \
-v /Users/aafall/Documents/docker/es/plugins:/usr/share/elasticsearch/plugins \
elasticsearch:7.17.2
# -d 后台运行容器，返回容器ID
# -e ES_JAVA_OPTS="-Xms64m -Xmx512m" 配置内存大小
# -e "discovery.type=single-node" 单例模式
# -v 目录的映射
```

### 3.2 安装 IK 分词器

- 在线安装

  ```shell
  # 进入容器
  docker exec -it elasticsearch /bin/bash  
  # 安装对应版本
  ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.17.2/elasticsearch-analysis-ik-7.17.2.zip
  # https://github.com/medcl/elasticsearch-analysis-ik/releases
  ```

- 离线安装

## 四、连接方式

- transport ：通过 TCP 方式访问 ES 。

  > 对应的库是 [`org.elasticsearch.client.transport`](https://mvnrepository.com/artifact/org.elasticsearch.client/transport) 。

- rest ：通过 HTTP API 方式访问 ES 。

  > 对应的库是：
  >
  > - [`elasticsearch-rest-client`](https://mvnrepository.com/artifact/org.elasticsearch.client/elasticsearch-rest-client) + [`org.elasticsearch.client.rest`](https://mvnrepository.com/artifact/org.elasticsearch.client/elasticsearch-rest-client)
  > - [`elasticsearch-rest-high-level-client`](https://mvnrepository.com/artifact/org.elasticsearch.client/elasticsearch-rest-high-level-client) ，提供 [high-level rest](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html) API 。从 Elasticsearch 6.0.0-beta1 开始提供。

我们在项目中，编写数据库操作的逻辑，使用 MyBatis 或者 JPA 为主，而不使用原生的 JDBC 。那么，我们在编写 Elasticsearch 操作的逻辑，也不**直接**使用上述的客户端，而是：

- [`spring-data-elasticsearch`](https://spring.io/projects/spring-data-elasticsearch) ，基于 Elasticsearch transport 客户端封装。
- [`spring-data-jest`](https://github.com/VanRoy/spring-data-jest) ，基于 Jest 客户端封装。

虽然这两者底层使用的不同客户端，但是都基于 [Spring Data](https://spring.io/projects/spring-data) 体系，所以项目在使用时，编写的代码是相同的。

### 4.1 Spring Data Jest

- 引入依赖

  ```xml
  <!-- 自动化配置 Spring Data Jest -->
   <dependency>
       <groupId>com.github.vanroy</groupId>
       <artifactId>spring-boot-starter-data-jest</artifactId>
       <version>3.2.5.RELEASE</version>
  </dependency>
  ```

### 4.2 Spring Data Elasticsearch

